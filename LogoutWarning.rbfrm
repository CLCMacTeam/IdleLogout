#tag WindowBegin Window LogoutWarning   BackColor       =   &cFFFFFF00   Backdrop        =   0   CloseButton     =   False   Compatibility   =   ""   Composite       =   False   Frame           =   7   FullScreen      =   False   FullScreenButton=   False   HasBackColor    =   False   Height          =   237   ImplicitInstance=   True   LiveResize      =   False   MacProcID       =   0   MaxHeight       =   32000   MaximizeButton  =   False   MaxWidth        =   32000   MenuBar         =   0   MenuBarVisible  =   False   MinHeight       =   64   MinimizeButton  =   False   MinWidth        =   64   Placement       =   2   Resizeable      =   False   Title           =   "Idle Logout"   Visible         =   True   Width           =   600   Begin PushButton BLogOut      AutoDeactivate  =   True      Bold            =   False      ButtonStyle     =   "0"      Cancel          =   False      Caption         =   "Log Out"      Default         =   False      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   False      Left            =   397      LockBottom      =   False      LockedInPosition=   False      LockLeft        =   True      LockRight       =   False      LockTop         =   True      Scope           =   0      TabIndex        =   1      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   0.0      TextUnit        =   0      Top             =   197      Underline       =   False      Visible         =   True      Width           =   80   End   Begin PushButton BMoreTime      AutoDeactivate  =   False      Bold            =   False      ButtonStyle     =   "0"      Cancel          =   False      Caption         =   "More time"      Default         =   True      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   False      Left            =   500      LockBottom      =   False      LockedInPosition=   False      LockLeft        =   True      LockRight       =   False      LockTop         =   True      Scope           =   0      TabIndex        =   2      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   0.0      TextUnit        =   0      Top             =   197      Underline       =   False      Visible         =   True      Width           =   80   End   Begin Label WarningTitle      AutoDeactivate  =   True      Bold            =   False      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   39      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   False      Left            =   112      LockBottom      =   False      LockedInPosition=   False      LockLeft        =   True      LockRight       =   False      LockTop         =   True      Multiline       =   False      Scope           =   0      Selectable      =   False      TabIndex        =   3      TabPanelIndex   =   0      Text            =   "PSU Idle Logout"      TextAlign       =   1      TextColor       =   &c00000000      TextFont        =   "System"      TextSize        =   30.0      TextUnit        =   0      Top             =   0      Transparent     =   False      Underline       =   False      Visible         =   True      Width           =   377   End   Begin Label WarningMessage      AutoDeactivate  =   True      Bold            =   False      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   84      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   False      Left            =   20      LockBottom      =   False      LockedInPosition=   False      LockLeft        =   True      LockRight       =   False      LockTop         =   True      Multiline       =   True      Scope           =   0      Selectable      =   False      TabIndex        =   4      TabPanelIndex   =   0      Text            =   "This Mac is idle.\r\rClick the ""More Time"" button to continue using the Mac.\r\rOtherwise, an automatic logout will occur and all unsaved documents will be LOST!"      TextAlign       =   0      TextColor       =   &c00000000      TextFont        =   "System"      TextSize        =   0.0      TextUnit        =   0      Top             =   34      Transparent     =   False      Underline       =   False      Visible         =   True      Width           =   560   End   Begin Label Seconds      AutoDeactivate  =   True      Bold            =   False      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   25      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   False      Left            =   20      LockBottom      =   False      LockedInPosition=   False      LockLeft        =   True      LockRight       =   False      LockTop         =   True      Multiline       =   False      Scope           =   0      Selectable      =   False      TabIndex        =   6      TabPanelIndex   =   0      Text            =   "Seconds remaining before automatic logout..."      TextAlign       =   0      TextColor       =   &c00000000      TextFont        =   "System"      TextSize        =   0.0      TextUnit        =   0      Top             =   127      Transparent     =   False      Underline       =   False      Visible         =   True      Width           =   301   End   Begin Thread IdleThread      Height          =   32      Index           =   -2147483648      InitialParent   =   ""      Left            =   13      LockedInPosition=   False      Priority        =   5      Scope           =   0      StackSize       =   0      TabPanelIndex   =   0      Top             =   268      Width           =   32   End   Begin Thread CountdownThread      Height          =   32      Index           =   -2147483648      InitialParent   =   ""      Left            =   57      LockedInPosition=   False      Priority        =   5      Scope           =   0      StackSize       =   0      TabPanelIndex   =   0      Top             =   268      Width           =   32   End   Begin Label TimeLabel      AutoDeactivate  =   True      Bold            =   False      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   51      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   False      Left            =   268      LockBottom      =   False      LockedInPosition=   False      LockLeft        =   True      LockRight       =   False      LockTop         =   True      Multiline       =   False      Scope           =   0      Selectable      =   False      TabIndex        =   5      TabPanelIndex   =   0      Text            =   ""      TextAlign       =   1      TextColor       =   &c00000000      TextFont        =   "System"      TextSize        =   30.0      TextUnit        =   0      Top             =   166      Transparent     =   False      Underline       =   False      Visible         =   True      Width           =   64   EndEnd#tag EndWindow#tag WindowCode	#tag Method, Flags = &h0		Sub forceLogout()		  		  // Testing mode, use say instead of logout		  Dim s As Shell		  s=New Shell		  dim ShellResults as string		  s.Mode = 0		  		  // s.Execute "say Logging Out" // Testing line		  		  pMoreTimeAskedFor = false		  		  LogToFile(CurrentMethodName + ": Time Out for Response. Log User Out...")		  		  // s.Execute "/bin/bash /Library/CLMadmin/psuForceLogOut.sh" // Use this line to test logouts		  		  LogToFile("Found User $currentuser")		  LogToFile("Killing Apps")		  		  LogToFile("Killing all launched from /Applications")		  // s.Execute("kill -9 `ps axxx | grep ""/Applications"" | awk '{print $1}'`")		  // ShellResults = s.Result		  LogToFile("App Kill Results: " + ShellResults)		  LogToFile("Killing the psuStartupManger")		  //s.Execute("kill -9 `ps axxx | grep ""/Library/CLMshared/Startup Items/psuStartupManager.app"" |grep applet | awk '{print $1}'`")		  // ShellResults = s.Result		  LogToFile("StartupManager Kill Results: " + ShellResults)		  LogToFile("Tell AppleScript to log it out")		  // Old method seems to fail now on 10.10.3!		  //s.Execute("osascript -e 'tell application ""System Events""' -e 'keystroke ""q"" using {command down, shift down, option down}' -e 'end tell'")		  // New method to logout with osascript.		  //s.Execute("osascript -e 'tell application ""System Events"" to keystroke ""q"" using {command down, shift down, option down}'")		  //ShellResults = s.Result		  LogToFile("LogOut AS Results: " + ShellResults)		  		  		  		  		  LogToFile(CurrentMethodName + ": <---")		  		  		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Function IdleSeconds() As Integer		  // Set up variables for idle time		  // Shell result		  Dim mIdleSecs As String		  // Shell exit code		  Dim merrCode As  Integer		  // Set up shell		  Dim s As Shell		  s=New Shell		  s.Mode = 0		  		  // Check idle time		  //s.Execute code to check idle time from USB input devices		  s.Execute "/bin/echo $((`/usr/sbin/ioreg -c IOHIDSystem | /usr/bin/sed -e '/HIDIdleTime/ !{ d' -e 't' -e '}' -e 's/.* = //g' -e 'q'` / 1000000000))"		  // Set results to mIdleResult		  mIdleSecs = s.Result		  // Set error code to mIdleError		  merrCode = s.ErrorCode		  // Log mIdleResult for debugging		  // System.Log(System.LogLevelError, "Method: " + midleSecs)		  // LogToFile("mIdleSeconds: " + str(mIdleSecs))		  Return val(mIdleSecs)		End Function	#tag EndMethod	#tag Method, Flags = &h0		Function makeFolder(mkdirPath As string) As Boolean		  // Set up variables for idle time		  // Shell result = mkdirPath		  // Shell exit code		  Dim merrCode As  Integer		  // Set up shell		  Dim s As Shell		  s=New Shell		  s.Mode = 0		  		  // Check idle time		  //s.Execute code to check idle time from USB input devices		  s.Execute "mkdir -p /Users/Shared"		  // Set results to mIdleResult		  mkdirPath = s.Result		  // Set error code to mIdleError		  merrCode = s.ErrorCode		  // Log mIdleResult for debugging		  // System.Log(System.LogLevelError, "Method: " + midleSecs)		  // LogToFile("mIdleSeconds: " + str(mIdleSecs))		  if mkdirPath = "0" then		    return true		  else		    return false		  end		End Function	#tag EndMethod	#tag Method, Flags = &h0		Function RemoteControlCheck() As Boolean		  // Set up variables for idle time		  Dim stablished as String = "ESTABLISHED"		  		  // Shell result		  Dim rccheck As String		  // Shell exit code		  Dim merrCode As  Integer		  // Set up shell		  Dim s As Shell		  s=New Shell		  s.Mode = 0		  		  		  // Check idle time		  //s.Execute code to check for connection		  s.Execute "/usr/sbin/netstat -n | /usr/bin/grep '.5900'| /usr/bin/awk '{print $6}'"		  		  // Set results to rccheck		  // Make the entire returned text uppercase in case Apple ever changes the case to CaMeL CaSe, which would break our code:		  rccheck = Uppercase(s.Result)		  		  //Testing line below		  // rccheck ="ESTABLISHED"		  		  //LogToFile("rccheck: " + rccheck)		  // Set error code to merrCode		  merrCode = s.ErrorCode		  		  // LogToFile("rccheck: "+ rccheck)		  // LogToFile("stablished: "+ stablished)		  		  If ( InStr( rccheck, stablished ) > 0 ) then		    return true		  else		    //LogToFile("rccheck: false")		    return false		  End if		  		  // System.Log(System.LogLevelError, "Method: " + midleSecs)		  // LogToFile("mIdleSeconds: " + str(mIdleSecs))		  		  		  		End Function	#tag EndMethod	#tag Method, Flags = &h0		Function WaitForIdleTime(paramNumSecondsIdleToWait as integer) As Boolean		  Dim mIdleResult As Integer		  mIdleResult = IdleSeconds()		  LogToFile(CurrentMethodName + " waiting for " + str(paramNumSecondsIdleToWait))		  while ( mIdleResult < paramNumSecondsIdleToWait )		    		    // Wait pIdleLoopDelaySeconds:		    App.SleepCurrentThread( pIdleLoopDelaySeconds * 1000 )		    		    // Check idle time:		    mIdleResult = IdleSeconds()		    		    LogToFile(CurrentMethodName + ": Idle Seconds: " + str(mIdleResult))		    		  wend		  		  // if there is a ARD/VNC session, don't idle out		  // netstat -n | grep '.5900'		  if ( RemoteControlCheck() ) then		    //LogToFile("rcCheck = true")		    LogToFile(CurrentMethodName + ": Someone is controlling via ARD/VNC, waiting...")		    return false		  else		    //LogToFile("rcCheck = false")		    LogToFile(CurrentMethodName + ": No one is controlling via ARD/VNC, continuing...")		    return true		  end if		  		  		End Function	#tag EndMethod	#tag Property, Flags = &h0		mTimeLabelValue As Integer = 0	#tag EndProperty	#tag Property, Flags = &h0		pComputerIdleAfterNumSeconds As Integer = 900	#tag EndProperty	#tag Property, Flags = &h0		pDefaultPrefsFileName As String = "edu.psu.its.clc.IdleLogoutSettings.plist"	#tag EndProperty	#tag Property, Flags = &h0		pDefaultPrefsFSPath As String = "/Library/CLMadmin/Config/"	#tag EndProperty	#tag Property, Flags = &h0		pIdleLoopDelaySeconds As Integer = 60	#tag EndProperty	#tag Property, Flags = &h0		pIgnoreGroup As String = "admin"	#tag EndProperty	#tag Property, Flags = &h0		pIgnoreUser As String = "macadmin"	#tag EndProperty	#tag Property, Flags = &h0		pMoreTimeAskedFor As Boolean = true	#tag EndProperty	#tag Property, Flags = &h0		pWaitForUserPromptSeconds As Integer = 90	#tag EndProperty	#tag Property, Flags = &h0		readyToQuit As Boolean = false	#tag EndProperty#tag EndWindowCode#tag Events BLogOut	#tag Event		Sub Action()		  // Testing code		  Dim s As Shell		  s=New Shell		  s.Mode = 0		  		  // s.execute "say logout" // Use this line to test logouts		  		  LogToFile("User chose LogOut")		  // No more time, please		  pMoreTimeAskedFor = false		  		  LogToFile("Kill open threads")		  CountdownThread.Kill		  IdleThread.Kill		  // Log out the user		  		  LogToFile("Quitting")		  		  s.Execute "/bin/bash /Library/CLMadmin/psuForceLogOut.sh" // Use this line to test logouts		  //s.execute "/usr/bin/sudo /Library/CLMshared/psuRebootNow.pl" // Use this line to test logouts		  		  Quit		End Sub	#tag EndEvent#tag EndEvents#tag Events BMoreTime	#tag Event		Sub Action()		  		  // Testing code		  Dim s As Shell		  s=New Shell		  s.Mode = 0		  // s.execute "say More Time"		  		  LogToFile("More Time Requested")		  // Ask for more time		  //pMoreTimeAskedFor = true		  // Resume IdleThread		  IdleThread.Resume		  // Stop the current countdown		  CountdownThread.Kill		  // Get rid of the window		  LogoutWarning.Hide		  		End Sub	#tag EndEvent	#tag Event		Function KeyDown(Key As String) As Boolean		  		End Function	#tag EndEvent#tag EndEvents#tag Events IdleThread	#tag Event		Sub Run()		  LogToFile(CurrentMethodName + ": --->")		  		  // User has been idle 0 seconds so far		  // Dim idleTime as Integer = 0		  // How long to wait between checking idle time		  // Dim gLoopDelay as Integer = 30		  // pIdleTime = How long to wait before considering computer abandonded		  LogoutWarning.mTimeLabelValue = 0		  		  pMoreTimeAskedFor = false		  do		    If (NOT LogoutWarning.Visible) then		      LogToFile(CurrentMethodName + "LogoutWarning not visible yet")		      if ( LogoutWarning.WaitForIdleTime( LogoutWarning.pComputerIdleAfterNumSeconds ) ) then		        LogToFile(CurrentMethodName + ": Ready to start CountdownThread")		        		        LogToFile(CurrentMethodName + ": CountdownThread Start")		        LogoutWarning.Show()		        LogoutWarning.CountdownThread.Run		        //UpdateTimer.Mode = Timer.ModeMultiple		        		      else		        LogToFile(CurrentMethodName + ": Not Idle Yet...")		      end if		    else		      // Do Nothing...		      // LogToFile(CurrentMethodName + ": Waiting for user...")		      		    end if		    //LogToFile("pMoreTimeAskedFor = " + str(pMoreTimeAskedFor))		    		  Loop until ( LogoutWarning.readyToQuit )		  LogToFile(CurrentMethodName + ": Ready to quit!")		  		  LogToFile(CurrentMethodName + ": <---")		  //////// OLD METHOD FROM IDLETHREAD		End Sub	#tag EndEvent#tag EndEvents#tag Events CountdownThread	#tag Event		Sub Run()		  LogToFile(CurrentMethodName + ": --->")		  		  // Set how long to wait before logging out user, set from global variable for LogOutDelay		  Dim pLogoutDelay as Integer = pWaitForUserPromptSeconds		  		  //LogoutWarning.Show()		  // Stop the idle thread		  // IdleThread.Suspend		  		  		  // While we're waiting for the countdown to finish...		  While pLogoutDelay >= 0		    // Set label to the time left		    // TimeLabel.setString(str(pLogoutDelay))		    // Refresh it		    // TimeLabel.Refresh		    mTimeLabelValue = pLogoutDelay		    // take a second away from the time left		    pLogoutDelay = pLogoutDelay - 1		    // do nothing for 1 second		    		    App.SleepCurrentThread( 1000 ) // sleep 1 second		    		  Wend		  		  // If we're here, the user didn't cancel or log out manaully		  		  // Testing mode, use say instead of logout		  Dim s As Shell		  s=New Shell		  s.Mode = 0		  		  // s.Execute "say Logging Out" // Testing line		  		  pMoreTimeAskedFor = false		  		  LogToFile(CurrentMethodName + ": Time Out for Response. Log User Out...")		  		  		  LogToFile(CurrentMethodName + ": <---")		  		  		  //s.Execute "/usr/bin/sudo /Library/CLMshared/psuRebootNow.pl" // Run script to reboot Mac		  //s.Execute "/bin/bash /Library/CLMadmin/psuForceLogOut.sh" // Use this line to test logouts		  LogoutWarning.forceLogout		  		  // Quit app		  Quit		  		End Sub	#tag EndEvent#tag EndEvents#tag ViewBehavior	#tag ViewProperty		Name="BackColor"		Visible=true		Group="Appearance"		InitialValue="&hFFFFFF"		Type="Color"	#tag EndViewProperty	#tag ViewProperty		Name="Backdrop"		Visible=true		Group="Appearance"		Type="Picture"		EditorType="Picture"	#tag EndViewProperty	#tag ViewProperty		Name="CloseButton"		Visible=true		Group="Appearance"		InitialValue="True"		Type="Boolean"		EditorType="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="Composite"		Visible=true		Group="Appearance"		InitialValue="False"		Type="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="Frame"		Visible=true		Group="Appearance"		InitialValue="0"		Type="Integer"		EditorType="Enum"		#tag EnumValues			"0 - Document"			"1 - Movable Modal"			"2 - Modal Dialog"			"3 - Floating Window"			"4 - Plain Box"			"5 - Shadowed Box"			"6 - Rounded Window"			"7 - Global Floating Window"			"8 - Sheet Window"			"9 - Metal Window"			"10 - Drawer Window"			"11 - Modeless Dialog"		#tag EndEnumValues	#tag EndViewProperty	#tag ViewProperty		Name="FullScreen"		Group="Appearance"		InitialValue="False"		Type="Boolean"		EditorType="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="FullScreenButton"		Visible=true		Group="Appearance"		InitialValue="False"		Type="Boolean"		EditorType="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="HasBackColor"		Visible=true		Group="Appearance"		InitialValue="False"		Type="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="Height"		Visible=true		Group="Position"		InitialValue="400"		Type="Integer"	#tag EndViewProperty	#tag ViewProperty		Name="ImplicitInstance"		Visible=true		Group="Appearance"		InitialValue="True"		Type="Boolean"		EditorType="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="Interfaces"		Visible=true		Group="ID"		Type="String"		EditorType="String"	#tag EndViewProperty	#tag ViewProperty		Name="LiveResize"		Visible=true		Group="Appearance"		InitialValue="True"		Type="Boolean"		EditorType="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="MacProcID"		Visible=true		Group="Appearance"		InitialValue="0"		Type="Integer"	#tag EndViewProperty	#tag ViewProperty		Name="MaxHeight"		Visible=true		Group="Position"		InitialValue="32000"		Type="Integer"	#tag EndViewProperty	#tag ViewProperty		Name="MaximizeButton"		Visible=true		Group="Appearance"		InitialValue="True"		Type="Boolean"		EditorType="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="MaxWidth"		Visible=true		Group="Position"		InitialValue="32000"		Type="Integer"	#tag EndViewProperty	#tag ViewProperty		Name="MenuBar"		Visible=true		Group="Appearance"		Type="MenuBar"		EditorType="MenuBar"	#tag EndViewProperty	#tag ViewProperty		Name="MenuBarVisible"		Group="Appearance"		InitialValue="True"		Type="Boolean"		EditorType="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="MinHeight"		Visible=true		Group="Position"		InitialValue="64"		Type="Integer"	#tag EndViewProperty	#tag ViewProperty		Name="MinimizeButton"		Visible=true		Group="Appearance"		InitialValue="True"		Type="Boolean"		EditorType="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="MinWidth"		Visible=true		Group="Position"		InitialValue="64"		Type="Integer"	#tag EndViewProperty	#tag ViewProperty		Name="Name"		Visible=true		Group="ID"		Type="String"		EditorType="String"	#tag EndViewProperty	#tag ViewProperty		Name="pComputerIdleAfterNumSeconds"		Group="Behavior"		InitialValue="900"		Type="Integer"	#tag EndViewProperty	#tag ViewProperty		Name="pDefaultPrefsFileName"		Group="Behavior"		InitialValue="edu.psu.its.clc.IdleLogoutSettings.plist"		Type="String"		EditorType="MultiLineEditor"	#tag EndViewProperty	#tag ViewProperty		Name="pDefaultPrefsFSPath"		Group="Behavior"		InitialValue="/Library/CLMadmin/Config/"		Type="String"		EditorType="MultiLineEditor"	#tag EndViewProperty	#tag ViewProperty		Name="pIdleLoopDelaySeconds"		Group="Behavior"		InitialValue="30"		Type="Integer"	#tag EndViewProperty	#tag ViewProperty		Name="pIgnoreGroup"		Group="Behavior"		InitialValue="admin"		Type="String"		EditorType="MultiLineEditor"	#tag EndViewProperty	#tag ViewProperty		Name="pIgnoreUser"		Group="Behavior"		InitialValue="macadmin"		Type="String"		EditorType="MultiLineEditor"	#tag EndViewProperty	#tag ViewProperty		Name="Placement"		Visible=true		Group="Position"		InitialValue="0"		Type="Integer"		EditorType="Enum"		#tag EnumValues			"0 - Default"			"1 - Parent Window"			"2 - Main Screen"			"3 - Parent Window Screen"			"4 - Stagger"		#tag EndEnumValues	#tag EndViewProperty	#tag ViewProperty		Name="pMoreTimeAskedFor"		Group="Behavior"		InitialValue="true"		Type="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="pWaitForUserPromptSeconds"		Group="Behavior"		InitialValue="90"		Type="Integer"	#tag EndViewProperty	#tag ViewProperty		Name="Resizeable"		Visible=true		Group="Appearance"		InitialValue="True"		Type="Boolean"		EditorType="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="Super"		Visible=true		Group="ID"		Type="String"		EditorType="String"	#tag EndViewProperty	#tag ViewProperty		Name="Title"		Visible=true		Group="Appearance"		InitialValue="Untitled"		Type="String"	#tag EndViewProperty	#tag ViewProperty		Name="Visible"		Visible=true		Group="Appearance"		InitialValue="True"		Type="Boolean"		EditorType="Boolean"	#tag EndViewProperty	#tag ViewProperty		Name="Width"		Visible=true		Group="Position"		InitialValue="600"		Type="Integer"	#tag EndViewProperty#tag EndViewBehavior